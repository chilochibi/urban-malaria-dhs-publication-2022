## These scripts are used to extract cluster level data and variables for urban settings in Nigeria
rm(list=ls())
memory.limit(size = 50000)
## -----------------------------------------
### Paths
## -----------------------------------------
user <- Sys.getenv("USERNAME")
Drive <- file.path(gsub("[\\]", "/", gsub("Documents", "", Sys.getenv("HOME"))))
NuDir <- file.path(Drive, "Box", "NU-malaria-team")
DataDir <- file.path(NuDir, "data", 'nigeria_dhs' , 'data_analysis', 'data')
GlobDir <- file.path(DataDir, 'africa_health_district_climate', 'climate', 'global')
DHSData <- file.path(DataDir, 'DHS')
RastDir <- file.path(DataDir, "Raster_files")
DataIn <- file.path(DHSData, "Computed_cluster_information", 'urban_malaria_covariates', 'DHS_survey_extract')
GeoDir <- file.path(DHSData, "Computed_cluster_information", 'urban_malaria_covariates', 'geospatial_covariates')
# -----------------------------------------
### Required functions and settings
## -----------------------------------------
source("./data_extractor_functions/data_extractor_functions.R")
options(survey.lonely.psu="adjust") # this option allows admin units with only one cluster to be analyzed
## ----------------------------------------------------
### Read in PR  data (DHS 2010, 2015, 2018)
## ----------------------------------------------------
dhs <- read.files(DataDir, "*NGPR.*\\.DTA", 'NGPR7AFL|NGPR71FL|NGPR61FL', read_dta)  #reads in the PR files
dhs[[1]]$hv102
table(dhs[[1]]$hv102)
table(dhs[[2]]$hv102)
table(dhs[[3]]$hv102)
dhs<- dhs %>% map(~mutate(., wealth = ifelse(hv270 <4, 0, 1),
floor_type = ifelse(hv213 >= 98, NA, ifelse(hv213 %in% c(30, 31, 33, 34, 35),1, 0)),
wall_type = ifelse(hv214 >= 98, NA , ifelse (hv214 %in% c(30, 31, 33, 34,35),1, 0)),
roof_type = ifelse(hv215 >= 98, NA, ifelse(hv215 %in% c(31),1, 0)),
housing_q = ifelse(floor_type == 1 & wall_type == 1 & roof_type == 1,1, 0),
all_female_sex = ifelse(hc27 == 1,0, 1),
female_child_sex = all_female_sex,
net_use = ifelse(hml12 %in% c(1,2), 1,0),
wt=hv005/1000000,strat=hv022,
id=hv021, num_p=1,
edu_a = ifelse(hv106 %in% c(0, 1, 2), 0,ifelse(hv106 >= 8, NA, ifelse(hv106 == 2|3, 1, NA))),
age = ifelse(hv105 >= 98, NA, hv105),
median_age = age,
mean_age =age,
household_size = hv013,
p_test = ifelse(hml32 > 1, NA, hml32),
U5_pop = ifelse(hc1 %in% c(0:59), 1, 0),
region = hv024, interview_month = hv006,
visitors = hv102)) %>%
map(~filter(., hv025 == 1)) %>%
map(~dplyr::select(., -c(hv013, hv105, hv106, hv021, hv005, hv022, hml12, hc27, hv215, hv214, hv213, hv270, hv024, hv006)))
pfpr_df <- dhs %>% map(~filter(., hv042 == 1 & hv103 == 1 & hc1 %in% c(6:59) & hml32 %in% c(0, 1,6))) #& hml16 <59 & hml32 %in% c(0, 1,6)
visitors_num <- dhs %>% map(~dplyr::select(., hv001, visitors)) %>%  map(~filter(., visitors == 0)) %>% map(~dplyr::group_by_(., 'hv001')) %>% map(~summarise(.,visitors = n())) %>%
plyr::ldply()
View(visitors_num)
hist(visitors_num)
hist(visitors_num$visitors)
View(visitors_num)
View(visitors_num)
View(estim_prop)
View(visitors_num)
write.csv(df_test, paste0(DataIn, "/num_visitors_DHS_10_15_18.csv"), row.names = FALSE)
write.csv(visitors_num, paste0(DataIn, "/num_visitors_DHS_10_15_18.csv"), row.names = FALSE)
