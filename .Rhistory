dhs_hh <- dhs_hh %>% map(~filter(., hv025 == 1)) %>%  map(~dplyr::select(., hv001, hv006, hv007)) %>%  map(~distinct(.,))
dhs_2010 <- left_join(st_as_sf(dhs[[1]]), dhs_hh[[1]], by = c("DHSCLUST"="hv001")) %>%
group_split(hv006) %>% setNames(paste0(unique(dhs_hh[[1]]$hv006), '_', unique(dhs_hh[[1]]$hv007)))
dhs_2010<-dhs_2010[order(names(dhs_2010))]
dhs_2015 <- left_join(st_as_sf(dhs[[2]]), dhs_hh[[2]], by = c("DHSCLUST"="hv001")) %>%
group_split(hv006) %>% setNames(paste0(unique(dhs_hh[[2]]$hv006), '_', unique(dhs_hh[[2]]$hv007)))
dhs_2018 <- left_join(st_as_sf(dhs[[3]]), dhs_hh[[3]], by = c("DHSCLUST"="hv001")) %>%
group_split(hv006) %>% setNames(paste0(unique(dhs_hh[[3]]$hv006), '_', unique(dhs_hh[[3]]$hv007)))
dhs_2018_ordered<- list(`08_2018`=dhs_2018$`8_2018`, `09_2018`=dhs_2018$`9_2018`, `10_2018`=dhs_2018$`10_2018`, `11_2018`=dhs_2018$`11_2018`, `12_2018`=dhs_2018$`12_2018`)
dhs_month <- sapply(c(dhs_2010, dhs_2015, dhs_2018_ordered), sf:::as_Spatial, simplify = F)
names(dhs_month)
files <- list.files(path = file.path(RastDir , "EVI") ,pattern = "*.tif$", full.names = TRUE, recursive = FALSE)
raster <- sapply(files, raster, simplify = F)
for (i in 1:length(vars)) {
df <- map2(dhs_month, raster, get_crs)
df <- pmap(list(raster, df, vars[i]), extract_fun)
df <- plyr::ldply(df)
var_name <- paste0('EVI_', as.character(vars[i]), 'm')
df <- extrclean.fun(df, var_name)
write.csv(df, file = file.path(GeoDir, paste0('EVI_', as.character(vars[i]),
'm_buffer', "_DHS_10_15_18.csv")),row.names = FALSE)
}
files <- list.files(path = file.path(RastDir , "EVI") ,pattern = "*.tif$", full.names = TRUE, recursive = FALSE)
raster <- sapply(files, raster, simplify = F)
for (i in 1:length(vars)) {
var_name <- paste0('EVI_', as.character(vars[i]), 'm')
df <- map2(dhs_month, raster, get_crs)
df <- pmap(list(raster, df, vars[i]), extract_fun)
df <- plyr::ldply(df)
df <- df %>%  map(~rename_with(., .fn=~paste0(var_name), .cols = contains('EVI')))
df <- plyr::ldply(df)%>% dplyr::select(-c(ID))
write.csv(df, file = file.path(GeoDir, paste0('EVI_', as.character(vars[i]),
'm_buffer', "_DHS_10_15_18.csv")),row.names = FALSE)
}
files <- list.files(path = file.path(RastDir , "EVI") ,pattern = "*.tif$", full.names = TRUE, recursive = FALSE)
raster <- sapply(files, raster, simplify = F)
for (i in 1:length(vars)) {
var_name <- paste0('EVI_', as.character(vars[i]), 'm')
df <- map2(dhs_month, raster, get_crs)
df <- pmap(list(raster, df, vars[i]), extract_fun)
df <- plyr::ldply(df)
df <- df %>%  map(~rename_with(., .fn=~paste0(var_name), .cols = contains('EVI')))
df <- plyr::ldply(df)%>% dplyr::select(-c(ID))
write.csv(df, file = file.path(GeoDir, paste0('EVI_', as.character(vars[i]),
'm_buffer', "_DHS_10_15_18.csv")),row.names = FALSE)
}
View(df)
View(df)
df <- map2(dhs_month, raster, get_crs)
df <- pmap(list(raster, df, vars[1]), extract_fun)
View(df)
View(df[["/Users/ifeomaozodiegwu/Box/NU-malaria-team/data/nigeria_dhs/data_analysis/data/Raster_files/EVI/EVI_v6.2010.10.mean.1km.tif"]])
View(extract_fun)
dhs_month
dhs_month <- sapply(c(dhs_2010, dhs_2015, dhs_2018_ordered), sf:::as_Spatial, simplify = F)
View(dhs_month)
dhs_hh <- read.files(DataDir, "*NGPR.*\\.DTA", 'NGPR7AFL|NGPR71FL|NGPR61FL', read_dta)  #reads in the PR files
dhs_hh <- dhs_hh %>% map(~filter(., hv025 == 1)) %>%  map(~dplyr::select(., hv001, hv006, hv007)) %>%  map(~distinct(.,))
dhs_2010 <- left_join(st_as_sf(dhs[[1]]), dhs_hh[[1]], by = c("DHSCLUST"="hv001")) %>%
group_split(hv006) %>% setNames(paste0(unique(dhs_hh[[1]]$hv006), '_', unique(dhs_hh[[1]]$hv007)))
dhs_2010<-dhs_2010[order(names(dhs_2010))]
dhs_2015 <- left_join(st_as_sf(dhs[[2]]), dhs_hh[[2]], by = c("DHSCLUST"="hv001")) %>%
group_split(hv006) %>% setNames(paste0(unique(dhs_hh[[2]]$hv006), '_', unique(dhs_hh[[2]]$hv007)))
dhs_2018 <- left_join(st_as_sf(dhs[[3]]), dhs_hh[[3]], by = c("DHSCLUST"="hv001")) %>%
group_split(hv006) %>% setNames(paste0(unique(dhs_hh[[3]]$hv006), '_', unique(dhs_hh[[3]]$hv007)))
dhs_2018_ordered<- list(`08_2018`=dhs_2018$`8_2018`, `09_2018`=dhs_2018$`9_2018`, `10_2018`=dhs_2018$`10_2018`, `11_2018`=dhs_2018$`11_2018`, `12_2018`=dhs_2018$`12_2018`)
dhs <- sapply(c(dhs_2010, dhs_2015, dhs_2018_ordered), sf:::as_Spatial, simplify = F)
names(dhs)
extract_fun_month <- function(raster, dhs, buffer){
clu_val<-raster::extract(raster,dhs, buffer = buffer, fun = mean, df =TRUE) %>%
mutate(dhs_year = dhs$DHSYEAR, hv001 = dhs$DHSCLUST, month = dhs$hv007)
}
df <- map2(dhs, raster, get_crs)
df <- pmap(list(raster, df, vars[1]), extract_fun_month)
View(df)
View(df[["/Users/ifeomaozodiegwu/Box/NU-malaria-team/data/nigeria_dhs/data_analysis/data/Raster_files/EVI/EVI_v6.2010.10.mean.1km.tif"]])
View(extract_fun_month)
View(estim_mean)
extract_fun_month <- function(raster, dhs, buffer){
clu_val<-raster::extract(raster,dhs, buffer = buffer, fun = mean, df =TRUE) %>%
mutate(dhs_year = dhs$DHSYEAR, hv001 = dhs$DHSCLUST, month = dhs$hv006)
}
rm(list=ls())
memory.limit(size = 50000)
## -----------------------------------------
### Paths
## -----------------------------------------
user <- Sys.getenv("USERNAME")
Drive <- file.path(gsub("[\\]", "/", gsub("Documents", "", Sys.getenv("HOME"))))
NuDir <- file.path(Drive, "Box", "NU-malaria-team")
DataDir <- file.path(NuDir, "data", 'nigeria_dhs' , 'data_analysis', 'data')
GlobDir <- file.path(DataDir, 'africa_health_district_climate', 'climate', 'global')
DHSData <- file.path(DataDir, 'DHS')
RastDir <- file.path(DataDir, "Raster_files")
DataIn <- file.path(DHSData, "Computed_cluster_information", 'urban_malaria_covariates', 'DHS_survey_extract')
GeoDir <- file.path(DHSData, "Computed_cluster_information", 'urban_malaria_covariates', 'geospatial_covariates')
# -----------------------------------------
### Required functions and settings
## -----------------------------------------
source("./functions/data_extractor_functions.R")
dhs <- read.files(DHSData, "*FL.shp$", 'NGGE61FL|NGGE71FL|NGGE7BFL', shapefile) #read in DHS clusters
dhs <- map(dhs, st_as_sf) %>%  map(~filter(.x, URBAN_RURA == "U")) %>% map(sf:::as_Spatial)
# buffers of interest
vars <- c(0, 1000, 2000, 3000, 4000)
dhs_hh <- read.files(DataDir, "*NGPR.*\\.DTA", 'NGPR7AFL|NGPR71FL|NGPR61FL', read_dta)  #reads in the PR files
dhs_hh <- dhs_hh %>% map(~filter(., hv025 == 1)) %>%  map(~dplyr::select(., hv001, hv006, hv007)) %>%  map(~distinct(.,))
dhs_2010 <- left_join(st_as_sf(dhs[[1]]), dhs_hh[[1]], by = c("DHSCLUST"="hv001")) %>%
group_split(hv006) %>% setNames(paste0(unique(dhs_hh[[1]]$hv006), '_', unique(dhs_hh[[1]]$hv007)))
dhs_2010<-dhs_2010[order(names(dhs_2010))]
dhs_2015 <- left_join(st_as_sf(dhs[[2]]), dhs_hh[[2]], by = c("DHSCLUST"="hv001")) %>%
group_split(hv006) %>% setNames(paste0(unique(dhs_hh[[2]]$hv006), '_', unique(dhs_hh[[2]]$hv007)))
dhs_2018 <- left_join(st_as_sf(dhs[[3]]), dhs_hh[[3]], by = c("DHSCLUST"="hv001")) %>%
group_split(hv006) %>% setNames(paste0(unique(dhs_hh[[3]]$hv006), '_', unique(dhs_hh[[3]]$hv007)))
dhs_2018_ordered<- list(`08_2018`=dhs_2018$`8_2018`, `09_2018`=dhs_2018$`9_2018`, `10_2018`=dhs_2018$`10_2018`, `11_2018`=dhs_2018$`11_2018`, `12_2018`=dhs_2018$`12_2018`)
dhs <- sapply(c(dhs_2010, dhs_2015, dhs_2018_ordered), sf:::as_Spatial, simplify = F)
names(dhs)
iles <- list.files(path = file.path(RastDir , "EVI") ,pattern = "*.tif$", full.names = TRUE, recursive = FALSE)
raster <- sapply(files, raster, simplify = F)
files <- list.files(path = file.path(RastDir , "EVI") ,pattern = "*.tif$", full.names = TRUE, recursive = FALSE)
raster <- sapply(files, raster, simplify = F)
files
df <- map2(dhs, raster, get_crs)
df <- pmap(list(raster, df, vars[1]), extract_fun_month)
View(df)
View(df[["/Users/ifeomaozodiegwu/Box/NU-malaria-team/data/nigeria_dhs/data_analysis/data/Raster_files/EVI/EVI_v6.2010.10.mean.1km.tif"]])
df <- plyr::ldply(df)
View(df)
var_name <- paste0('EVI_', as.character(vars[1]), 'm')
df <- map2(dhs, raster, get_crs)
df <- pmap(list(raster, df, vars[1]), extract_fun_month)
df <- df %>%  map(~rename_with(., .fn=~paste0(var_name), .cols = contains('EVI')))
View(df)
View(df[["/Users/ifeomaozodiegwu/Box/NU-malaria-team/data/nigeria_dhs/data_analysis/data/Raster_files/EVI/EVI_v6.2010.10.mean.1km.tif"]])
View(df[["/Users/ifeomaozodiegwu/Box/NU-malaria-team/data/nigeria_dhs/data_analysis/data/Raster_files/EVI/EVI_v6.2010.11.mean.1km.tif"]])
View(df[["/Users/ifeomaozodiegwu/Box/NU-malaria-team/data/nigeria_dhs/data_analysis/data/Raster_files/EVI/EVI_v6.2010.11.mean.1km.tif"]])
View(df[["/Users/ifeomaozodiegwu/Box/NU-malaria-team/data/nigeria_dhs/data_analysis/data/Raster_files/EVI/EVI_v6.2010.12.mean.1km.tif"]])
View(df[["/Users/ifeomaozodiegwu/Box/NU-malaria-team/data/nigeria_dhs/data_analysis/data/Raster_files/EVI/EVI_v6.2010.11.mean.1km.tif"]])
View(df[["/Users/ifeomaozodiegwu/Box/NU-malaria-team/data/nigeria_dhs/data_analysis/data/Raster_files/EVI/EVI_v6.2010.12.mean.1km.tif"]])
View(dhs)
View(raster)
var_name <- paste0('EVI_', as.character(vars[1]), 'm')
df <- map2(dhs, raster, get_crs)
View(df)
View(dhs)
dhs_hh <- read.files(DataDir, "*NGPR.*\\.DTA", 'NGPR7AFL|NGPR71FL|NGPR61FL', read_dta)  #reads in the PR files
dhs_hh <- dhs_hh %>% map(~filter(., hv025 == 1)) %>%  map(~dplyr::select(., hv001, hv006, hv007)) %>%  map(~distinct(.,))
dhs_2010 <- left_join(st_as_sf(dhs[[1]]), dhs_hh[[1]], by = c("DHSCLUST"="hv001")) %>%
group_split(hv006) %>% setNames(paste0(unique(dhs_hh[[1]]$hv006), '_', unique(dhs_hh[[1]]$hv007)))
dhs <- read.files(DHSData, "*FL.shp$", 'NGGE61FL|NGGE71FL|NGGE7BFL', shapefile) #read in DHS clusters
dhs <- map(dhs, st_as_sf) %>%  map(~filter(.x, URBAN_RURA == "U")) %>% map(sf:::as_Spatial)
# buffers of interest
vars <- c(0, 1000, 2000, 3000, 4000)
dhs_hh <- read.files(DataDir, "*NGPR.*\\.DTA", 'NGPR7AFL|NGPR71FL|NGPR61FL', read_dta)  #reads in the PR files
dhs_hh <- dhs_hh %>% map(~filter(., hv025 == 1)) %>%  map(~dplyr::select(., hv001, hv006, hv007)) %>%  map(~distinct(.,))
dhs_2010 <- left_join(st_as_sf(dhs[[1]]), dhs_hh[[1]], by = c("DHSCLUST"="hv001")) %>%
group_split(hv006) %>% setNames(paste0(unique(dhs_hh[[1]]$hv006), '_', unique(dhs_hh[[1]]$hv007)))
View(dhs_2010)
left_join(st_as_sf(dhs[[1]]), dhs_hh[[1]], by = c("DHSCLUST"="hv001")) %>%
group_split(hv006)
dhs_2010 <- left_join(st_as_sf(dhs[[1]]), dhs_hh[[1]], by = c("DHSCLUST"="hv001")) %>%
group_split(hv006)
View(dhs_2010)
for(i in seq_along(dhs_2010)) {
names(i) <- setNames(paste0(unique(dhs_2010[[i]]$hv006), '_', unique(dhs_2010[[i]]$hv007)))
}
for(i in seq_along(dhs_2010)) {
names(i) <- paste0(unique(dhs_2010[[i]]$hv006), '_', unique(dhs_2010[[i]]$hv007))
}
View(dhs_2010)
names(dhs_2010)[[1]]
for(i in seq_along(dhs_2010)) {
names(dhs_2010)[[i]] <- paste0(unique(dhs_2010[[i]]$hv006), '_', unique(dhs_2010[[i]]$hv007))
}
View(dhs_2010)
View(dhs_2010)
dhs_2015 <- left_join(st_as_sf(dhs[[2]]), dhs_hh[[2]], by = c("DHSCLUST"="hv001")) %>%
group_split(hv006)
for(i in seq_along(dhs_2015)) {names(dhs_2015)[[i]] <- paste0(unique(dhs_2015[[i]]$hv006), '_', unique(dhs_2015[[i]]$hv007))}
View(dhs_2015)
dhs_2018 <- left_join(st_as_sf(dhs[[3]]), dhs_hh[[3]], by = c("DHSCLUST"="hv001")) %>%
group_split(hv006)
for(i in seq_along(dhs_2018)) {names(dhs_2018)[[i]] <- paste0(unique(dhs_2018[[i]]$hv006), '_', unique(dhs_2018[[i]]$hv007))}
View(dhs_2018)
View(dhs_2018)
dhs <- sapply(c(dhs_2010, dhs_2015, dhs_2018), sf:::as_Spatial, simplify = F)
names(dhs)
var_name <- paste0('EVI_', as.character(vars[1]), 'm')
df <- map2(dhs, raster, get_crs)
df <- pmap(list(raster, df, vars[1]), extract_fun_month)
df <- df %>%  map(~rename_with(., .fn=~paste0(var_name), .cols = contains('EVI')))
View(df)
View(df[["/Users/ifeomaozodiegwu/Box/NU-malaria-team/data/nigeria_dhs/data_analysis/data/Raster_files/EVI/EVI_v6.2010.10.mean.1km.tif"]])
df
for (i in 1:length(vars)) {
var_name <- paste0('EVI_', as.character(vars[1]), 'm')
df <- map2(dhs, raster, get_crs)
df <- pmap(list(raster, df, vars[1]), extract_fun_month)
df <- df %>%  map(~rename_with(., .fn=~paste0(var_name), .cols = contains('EVI')))
df <- plyr::ldply(df)%>% dplyr::select(-c(ID))
write.csv(df, file = file.path(GeoDir, paste0('EVI_', as.character(vars[i]),
'm_buffer', "_DHS_10_15_18.csv")),row.names = FALSE)
}
rm(list=ls())
#memory.limit(size = 50000)
# ----------------------------------------------------
### Directories
# ----------------------------------------------------
user = Sys.getenv("USERNAME")
Drive = file.path(gsub("[\\]", "/", gsub("Documents", "", Sys.getenv("HOME"))))
NuDir = file.path(Drive, "Box", "NU-malaria-team")
ProjectDir = file.path(NuDir, 'data', 'nigeria_dhs' , 'data_analysis')
DataDir = file.path(ProjectDir, "data")
DHSData = file.path(DataDir, 'DHS')
DataIn = file.path(DHSData, "Computed_cluster_information", 'urban_malaria_covariates', 'DHS_survey_extract')
ResultDir =file.path(ProjectDir, "results", "research_plots")
HisDir =file.path(ResultDir, "histograms")
MapsDir = file.path(ResultDir, "maps")
CsvDir = file.path(DHSData, "Computed_cluster_information", 'urban_malaria_covariates', 'cleaned_cluster_covariates_all', 'New_082321')
library(ggcorrplot)
# ----------------------------------------------------
### Required functions and settings
## ----------------------------------------------------
source("./functions/descriptive_analysis_functions.R")
files = list.files(path = CsvDir, pattern = '.csv', full.names = TRUE, recursive = FALSE)
files = files[-grep('all_DHS_variables_urban', files)]
df_geo = sapply(files, read.csv, simplify = F)
df_geo
View(df_geo)
rm(list=ls())
#memory.limit(size = 50000)
## -----------------------------------------
### Paths
## -----------------------------------------
Drive <- file.path(gsub("[\\]", "/", gsub("Documents", "", Sys.getenv("HOME"))))
NuDir <- file.path(Drive, "Box", "NU-malaria-team")
NGDir <-file.path(NuDir, "data", "nigeria_dhs",  "data_analysis")
DataDir <-file.path(NGDir, "data")
ResultDir <-file.path(NGDir, "results")
DHSData <- file.path(DataDir, 'DHS')
DataIn <- file.path(DHSData, "Computed_cluster_information", 'urban_malaria_covariates')
ifelse(!dir.exists(file.path(DataIn, "cleaned_cluster_covariates_all")),
dir.create(file.path(DataIn, "cleaned_cluster_covariates_all")), FALSE)
cleandatDir <- file.path(DataIn, 'cleaned_cluster_covariates_all')
buffer <- c('_1000m_|_2000m_|_3000m_|_4000m_',  '_0m_|_2000m_|_3000m_|_4000m_', '_0m_|_1000m_|_3000m_|_4000m_','_0m_|_1000m_|_2000m_|_4000m_', '_0m_|_1000m_|_2000m_|_3000m_')
df_geo<- list()
for (i in 1:length(buffer)){
files <- list.files(path = file.path(DataIn, 'geospatial_covariates') , pattern = '.csv', full.names = TRUE, recursive = FALSE)
files<- files[-grep('pop_density_FB|secondary_vector_', files)]
files <- files[-grep(buffer[[i]], files)]
df<-sapply(files, read.csv, simplify = F)
df <- df %>% map_if(~ all(c('hv001') %in% colnames(.x)), ~rename(., v001 = hv001))
df<- df[order(sapply(df,nrow),decreasing = T)]
df<- df %>% map_if(~ all(c('.id|month') %in% colnames(.x)),~dplyr::select(., -.id, -month))
df <- df %>%  purrr::reduce(left_join, by = c('dhs_year', 'v001')) %>%  mutate(dhs_year = as.character(dhs_year))
df_geo <- append(df_geo, list(df))
}
View(df)
rm(list=ls())
#memory.limit(size = 50000)
## -----------------------------------------
### Paths
## -----------------------------------------
Drive <- file.path(gsub("[\\]", "/", gsub("Documents", "", Sys.getenv("HOME"))))
NuDir <- file.path(Drive, "Box", "NU-malaria-team")
NGDir <-file.path(NuDir, "data", "nigeria_dhs",  "data_analysis")
DataDir <-file.path(NGDir, "data")
ResultDir <-file.path(NGDir, "results")
DHSData <- file.path(DataDir, 'DHS')
DataIn <- file.path(DHSData, "Computed_cluster_information", 'urban_malaria_covariates')
ifelse(!dir.exists(file.path(DataIn, "cleaned_cluster_covariates_all")),
dir.create(file.path(DataIn, "cleaned_cluster_covariates_all")), FALSE)
cleandatDir <- file.path(DataIn, 'cleaned_cluster_covariates_all')
buffer <- c('_1000m_|_2000m_|_3000m_|_4000m_',  '_0m_|_2000m_|_3000m_|_4000m_', '_0m_|_1000m_|_3000m_|_4000m_','_0m_|_1000m_|_2000m_|_4000m_', '_0m_|_1000m_|_2000m_|_3000m_')
df_geo<- list()
for (i in 1:length(buffer)){
files <- list.files(path = file.path(DataIn, 'geospatial_covariates') , pattern = '.csv', full.names = TRUE, recursive = FALSE)
files<- files[-grep('pop_density_FB|secondary_vector_', files)]
files <- files[-grep(buffer[[i]], files)]
df<-sapply(files, read.csv, simplify = F)
df <- df %>% map_if(~ all(c('hv001') %in% colnames(.x)), ~rename(., v001 = hv001))
df<- df[order(sapply(df,nrow),decreasing = T)]
df<- df %>% map_if(~ all(c('.id') %in% colnames(.x)),~dplyr::select(., -.id))
df<- df %>% map_if(~ all(c('month') %in% colnames(.x)),~dplyr::select(., -month))
df <- df %>%  purrr::reduce(left_join, by = c('dhs_year', 'v001')) %>%  mutate(dhs_year = as.character(dhs_year))
df_geo <- append(df_geo, list(df))
}
View(df)
rm(list=ls())
memory.limit(size = 50000)
## -----------------------------------------
### Paths
## -----------------------------------------
user <- Sys.getenv("USERNAME")
Drive <- file.path(gsub("[\\]", "/", gsub("Documents", "", Sys.getenv("HOME"))))
NuDir <- file.path(Drive, "Box", "NU-malaria-team")
DataDir <- file.path(NuDir, "data", 'nigeria_dhs' , 'data_analysis', 'data')
GlobDir <- file.path(DataDir, 'africa_health_district_climate', 'climate', 'global')
DHSData <- file.path(DataDir, 'DHS')
RastDir <- file.path(DataDir, "Raster_files")
DataIn <- file.path(DHSData, "Computed_cluster_information", 'urban_malaria_covariates', 'DHS_survey_extract')
GeoDir <- file.path(DHSData, "Computed_cluster_information", 'urban_malaria_covariates', 'geospatial_covariates')
# -----------------------------------------
### Required functions and settings
## -----------------------------------------
source("./functions/data_extractor_functions.R")
dhs <- read.files(DHSData, "*FL.shp$", 'NGGE61FL|NGGE71FL|NGGE7BFL', shapefile) #read in DHS clusters
dhs <- map(dhs, st_as_sf) %>%  map(~filter(.x, URBAN_RURA == "U")) %>% map(sf:::as_Spatial)
# buffers of interest
vars <- c(0, 1000, 2000, 3000, 4000)
dhs_hh <- read.files(DataDir, "*NGPR.*\\.DTA", 'NGPR7AFL|NGPR71FL|NGPR61FL', read_dta)  #reads in the PR files
dhs_hh <- dhs_hh %>% map(~filter(., hv025 == 1)) %>%  map(~dplyr::select(., hv001, hv006, hv007)) %>%  map(~distinct(.,))
dhs_2010 <- left_join(st_as_sf(dhs[[1]]), dhs_hh[[1]], by = c("DHSCLUST"="hv001")) %>%
group_split(hv006)
for(i in seq_along(dhs_2010)) {names(dhs_2010)[[i]] <- paste0(unique(dhs_2010[[i]]$hv006), '_', unique(dhs_2010[[i]]$hv007))}
dhs_2015 <- left_join(st_as_sf(dhs[[2]]), dhs_hh[[2]], by = c("DHSCLUST"="hv001")) %>%
group_split(hv006)
for(i in seq_along(dhs_2015)) {names(dhs_2015)[[i]] <- paste0(unique(dhs_2015[[i]]$hv006), '_', unique(dhs_2015[[i]]$hv007))}
dhs_2018 <- left_join(st_as_sf(dhs[[3]]), dhs_hh[[3]], by = c("DHSCLUST"="hv001")) %>%
group_split(hv006)
for(i in seq_along(dhs_2018)) {names(dhs_2018)[[i]] <- paste0(unique(dhs_2018[[i]]$hv006), '_', unique(dhs_2018[[i]]$hv007))}
dhs <- sapply(c(dhs_2010, dhs_2015, dhs_2018), sf:::as_Spatial, simplify = F)
names(dhs)
files <- list.files(path = file.path(RastDir , "EVI") ,pattern = "*.tif$", full.names = TRUE, recursive = FALSE)
raster <- sapply(files, raster, simplify = F)
for (i in 1:length(vars)) {
var_name <- paste0('EVI_', as.character(vars[i]), 'm')
df <- map2(dhs, raster, get_crs)
df <- pmap(list(raster, df, vars[1]), extract_fun_month)
df <- df %>%  map(~rename_with(., .fn=~paste0(var_name), .cols = contains('EVI')))
df <- plyr::ldply(df)%>% dplyr::select(-c(ID))
write.csv(df, file = file.path(GeoDir, paste0('EVI_', as.character(vars[i]),
'm_buffer', "_DHS_10_15_18.csv")),row.names = FALSE)
}
rm(list=ls())
#memory.limit(size = 50000)
# ----------------------------------------------------
### Directories
# ----------------------------------------------------
user = Sys.getenv("USERNAME")
Drive = file.path(gsub("[\\]", "/", gsub("Documents", "", Sys.getenv("HOME"))))
NuDir = file.path(Drive, "Box", "NU-malaria-team")
ProjectDir = file.path(NuDir, 'data', 'nigeria_dhs' , 'data_analysis')
DataDir = file.path(ProjectDir, "data")
DHSData = file.path(DataDir, 'DHS')
DataIn = file.path(DHSData, "Computed_cluster_information", 'urban_malaria_covariates', 'DHS_survey_extract')
ResultDir =file.path(ProjectDir, "results", "research_plots")
HisDir =file.path(ResultDir, "histograms")
MapsDir = file.path(ResultDir, "maps")
CsvDir = file.path(DHSData, "Computed_cluster_information", 'urban_malaria_covariates', 'cleaned_cluster_covariates_all', 'New_082321')
library(ggcorrplot)
# ----------------------------------------------------
### Required functions and settings
## ----------------------------------------------------
source("./functions/descriptive_analysis_functions.R")
files = list.files(path = CsvDir, pattern = '.csv', full.names = TRUE, recursive = FALSE)
files = files[-grep('all_DHS_variables_urban', files)]
df_geo = sapply(files, read.csv, simplify = F)
#find the number of NAs per column in geospatial data
df_nas = df_geo %>%  map(~summarise_all(., funs(sum(is.na(.)))))
names(df_nas[[1]])<- gsub(pattern = '\\_0m$', replacement = '_nas', x = names(df_nas[[1]]))#remove _0m from the 0m buffer dataset
for(i in seq_along(df_nas)){
names(df_nas[[i]])<- names(df_nas[[1]])
}
df_nas = bind_rows(df_nas, .id ='column label')
df_neg = df_geo %>%  map(~summarise_all(., funs(sum((.) < 0, na.rm=TRUE))))
names(df_neg[[1]])<- gsub(pattern = '\\_0m$', replacement = '_negs', x = names(df_neg[[1]]))#remove _0m from the 0m buffer dataset
for(i in seq_along(df_neg)){
names(df_neg[[i]])<- names(df_neg[[1]])
}
df_neg = bind_rows(df_neg, .id ='column label')
df_na_neg = cbind(df_nas, df_neg)
df_na_neg = df_na_neg[,order(colnames(df_na_neg))]
df_na_neg
rm(list=ls())
#memory.limit(size = 50000)
## -----------------------------------------
### Paths
## -----------------------------------------
Drive <- file.path(gsub("[\\]", "/", gsub("Documents", "", Sys.getenv("HOME"))))
NuDir <- file.path(Drive, "Box", "NU-malaria-team")
NGDir <-file.path(NuDir, "data", "nigeria_dhs",  "data_analysis")
DataDir <-file.path(NGDir, "data")
ResultDir <-file.path(NGDir, "results")
DHSData <- file.path(DataDir, 'DHS')
DataIn <- file.path(DHSData, "Computed_cluster_information", 'urban_malaria_covariates')
ifelse(!dir.exists(file.path(DataIn, "cleaned_cluster_covariates_all")),
dir.create(file.path(DataIn, "cleaned_cluster_covariates_all")), FALSE)
cleandatDir <- file.path(DataIn, 'cleaned_cluster_covariates_all')
buffer <- c('_1000m_|_2000m_|_3000m_|_4000m_',  '_0m_|_2000m_|_3000m_|_4000m_', '_0m_|_1000m_|_3000m_|_4000m_','_0m_|_1000m_|_2000m_|_4000m_', '_0m_|_1000m_|_2000m_|_3000m_')
df_geo<- list()
for (i in 1:length(buffer)){
files <- list.files(path = file.path(DataIn, 'geospatial_covariates') , pattern = '.csv', full.names = TRUE, recursive = FALSE)
files<- files[-grep('pop_density_FB|secondary_vector_', files)]
files <- files[-grep(buffer[[i]], files)]
df<-sapply(files, read.csv, simplify = F)
df <- df %>% map_if(~ all(c('hv001') %in% colnames(.x)), ~rename(., v001 = hv001))
df<- df[order(sapply(df,nrow),decreasing = T)]
df<- df %>% map_if(~ all(c('.id') %in% colnames(.x)),~dplyr::select(., -.id))
df<- df %>% map_if(~ all(c('month') %in% colnames(.x)),~dplyr::select(., -month))
df <- df %>%  purrr::reduce(left_join, by = c('dhs_year', 'v001')) %>%  mutate(dhs_year = as.character(dhs_year))
df_geo <- append(df_geo, list(df))
}
View(df_geo)
View(df_geo[[1]])
for (i in 1:length(buffer)){
files <- list.files(path = file.path(DataIn, 'geospatial_covariates') , pattern = '.csv', full.names = TRUE, recursive = FALSE)
files<- files[-grep('pop_density_FB|secondary_vector_', files)]
files <- files[-grep(buffer[[i]], files)]
df<-sapply(files, read.csv, simplify = F)
df <- df %>% map_if(~ all(c('hv001') %in% colnames(.x)), ~rename(., v001 = hv001))
df<- df[order(sapply(df,nrow),decreasing = T)]
df<- df %>% map_if(~ all(c('.id') %in% colnames(.x)),~dplyr::select(., -.id))
#df<- df %>% map_if(~ all(c('month') %in% colnames(.x)),~dplyr::select(., -month))
df <- df %>%  purrr::reduce(left_join, by = c('dhs_year', 'v001')) %>%  mutate(dhs_year = as.character(dhs_year))
df_geo <- append(df_geo, list(df))
}
files <- list.files(path = file.path(DataIn, 'geospatial_covariates') , pattern = '.csv', full.names = TRUE, recursive = FALSE)
files<- files[-grep('pop_density_FB|secondary_vector_', files)]
files <- files[-grep(buffer[[1]], files)]
df<-sapply(files, read.csv, simplify = F)
View(df)
df <- df %>% map_if(~ all(c('hv001') %in% colnames(.x)), ~rename(., v001 = hv001))
df<- df[order(sapply(df,nrow),decreasing = T)]
View(df)
df<- df %>% map_if(~ all(c('.id') %in% colnames(.x)),~dplyr::select(., -.id))
View(df)
df<- df %>% map_if(~ all(c('month') %in% colnames(.x)),~dplyr::select(., -month))
View(df)
View(df[["/Users/ifeomaozodiegwu/Box/NU-malaria-team/data/nigeria_dhs/data_analysis/data/DHS/Computed_cluster_information/urban_malaria_covariates/geospatial_covariates/EVI_0m_buffer_DHS_10_15_18.csv"]])
df <- df %>%  purrr::reduce(left_join, by = c('dhs_year', 'v001'))
View(df)
files <- list.files(path = file.path(DataIn, 'geospatial_covariates') , pattern = '.csv', full.names = TRUE, recursive = FALSE)
files<- files[-grep('pop_density_FB|secondary_vector_|EVI', files)]
files <- files[-grep(buffer[[1]], files)]
df<-sapply(files, read.csv, simplify = F)
df <- df %>% map_if(~ all(c('hv001') %in% colnames(.x)), ~rename(., v001 = hv001))
df<- df[order(sapply(df,nrow),decreasing = T)]
df<- df %>% map_if(~ all(c('.id') %in% colnames(.x)),~dplyr::select(., -.id))
df<- df %>% map_if(~ all(c('month') %in% colnames(.x)),~dplyr::select(., -month))
df <- df %>%  purrr::reduce(left_join, by = c('dhs_year', 'v001'))
files <- list.files(path = file.path(DataIn, 'geospatial_covariates') , pattern = '.csv', full.names = TRUE, recursive = FALSE)
files<- files[-grep('pop_density_FB|secondary_vector_', files)]
files <- files[-grep(buffer[[1]], files)]
df<-sapply(files, read.csv, simplify = F)
df <- df %>% map_if(~ all(c('hv001') %in% colnames(.x)), ~rename(., v001 = hv001))
df<- df[order(sapply(df,nrow),decreasing = T)]
df<- df %>% map_if(~ all(c('.id') %in% colnames(.x)),~dplyr::select(., -.id))
df<- df %>% map_if(~ all(c('month') %in% colnames(.x)),~dplyr::select(., -month))
View(df)
View(df)
View(df[["/Users/ifeomaozodiegwu/Box/NU-malaria-team/data/nigeria_dhs/data_analysis/data/DHS/Computed_cluster_information/urban_malaria_covariates/geospatial_covariates/EVI_0m_buffer_DHS_10_15_18.csv"]])
check = df[[1]] %>%  left_join(df[[2]], by = c('dhs_year', 'v001'))
View(check)
View(df[["/Users/ifeomaozodiegwu/Box/NU-malaria-team/data/nigeria_dhs/data_analysis/data/DHS/Computed_cluster_information/urban_malaria_covariates/geospatial_covariates/EVI_0m_buffer_DHS_10_15_18.csv"]])
View(df[["/Users/ifeomaozodiegwu/Box/NU-malaria-team/data/nigeria_dhs/data_analysis/data/DHS/Computed_cluster_information/urban_malaria_covariates/geospatial_covariates/soil_wetness_0m_buffer_DHS_10_15_18.csv"]])
buffer <- c('_1000m_|_2000m_|_3000m_|_4000m_',  '_0m_|_2000m_|_3000m_|_4000m_', '_0m_|_1000m_|_3000m_|_4000m_','_0m_|_1000m_|_2000m_|_4000m_', '_0m_|_1000m_|_2000m_|_3000m_')
df_geo<- list()
for (i in 1:length(buffer)){
files <- list.files(path = file.path(DataIn, 'geospatial_covariates') , pattern = '.csv', full.names = TRUE, recursive = FALSE)
files<- files[-grep('pop_density_FB|secondary_vector_', files)]
files <- files[-grep(buffer[[1]], files)]
df<-sapply(files, read.csv, simplify = F)
df <- df %>% map_if(~ all(c('hv001') %in% colnames(.x)), ~rename(., v001 = hv001))
df<- df[order(sapply(df,nrow),decreasing = T)]
df<- df %>% map_if(~ all(c('.id') %in% colnames(.x)),~dplyr::select(., -.id))
df<- df %>% map_if(~ all(c('month') %in% colnames(.x)),~dplyr::select(., -month))
df <- df %>%  purrr::reduce(left_join, by = c('dhs_year', 'v001')) %>%  mutate(dhs_year = as.character(dhs_year))
df_geo <- append(df_geo, list(df))
}
buffer <- c('_1000m_|_2000m_|_3000m_|_4000m_',  '_0m_|_2000m_|_3000m_|_4000m_', '_0m_|_1000m_|_3000m_|_4000m_','_0m_|_1000m_|_2000m_|_4000m_', '_0m_|_1000m_|_2000m_|_3000m_')
df_geo<- list()
for (i in 1:length(buffer)){
files <- list.files(path = file.path(DataIn, 'geospatial_covariates') , pattern = '.csv', full.names = TRUE, recursive = FALSE)
files<- files[-grep('pop_density_FB|secondary_vector|EVI', files)]
files <- files[-grep(buffer[[1]], files)]
df<-sapply(files, read.csv, simplify = F)
df <- df %>% map_if(~ all(c('hv001') %in% colnames(.x)), ~rename(., v001 = hv001))
df<- df[order(sapply(df,nrow),decreasing = T)]
df<- df %>% map_if(~ all(c('.id') %in% colnames(.x)),~dplyr::select(., -.id))
df<- df %>% map_if(~ all(c('month') %in% colnames(.x)),~dplyr::select(., -month))
df <- df %>%  purrr::reduce(left_join, by = c('dhs_year', 'v001')) %>%  mutate(dhs_year = as.character(dhs_year))
df_geo <- append(df_geo, list(df))
}
files <- list.files(path = file.path(DataIn, 'geospatial_covariates') , pattern = '.csv', full.names = TRUE, recursive = TRUE)
files<- files[grep('EVI', files)]
files
df_EVI <-sapply(files, read.csv, simplify = F)
View(df_EVI)
files <- list.files(path = file.path(DataIn, 'geospatial_covariates') , pattern = '.csv', full.names = TRUE, recursive = TRUE)
files<- files[grep('EVI', files)]
files <- files[-grep(buffer[[i]], files)]
df_EVI <-sapply(files, read.csv, simplify = F)
View(df_EVI)
files <- list.files(path = file.path(DataIn, 'geospatial_covariates') , pattern = '.csv', full.names = TRUE, recursive = TRUE)
files<- files[grep('EVI', files)]
files <- files[-grep(buffer[[1]], files)]
df_EVI <-sapply(files, read.csv, simplify = F)
df_EVI <- df_EVI %>% map_if(~ all(c('month') %in% colnames(.x)),~dplyr::select(., -month))
View(df_EVI)
df_EVI <- df_EVI %>% map_if(~ all(c('.id') %in% colnames(.x)),~dplyr::select(., -.id))
View(df_EVI)
View(df_EVI)
buffer_label <- c('0m', '1000m', '2000m', '3000m', '4000m')
df_EVI <- df_EVI[[1]] %>%  group_by(v001) %>%  mutate(paste0('first_month_EVI', '_', buffer_label[[i]]) = dplyr::first(starts_with('EVI'))) %>%  dplyr::select(-c(paste0('first_month_EVI', '_', buffer_label[[i]]))) %>%  distinct()
paste0('first_month_EVI', '_', buffer_label[[i]])
View(df_EVI)
View(df)
View(df_EVI)
View(df_EVI[["/Users/ifeomaozodiegwu/Box/NU-malaria-team/data/nigeria_dhs/data_analysis/data/DHS/Computed_cluster_information/urban_malaria_covariates/geospatial_covariates/EVI_0m_buffer_DHS_10_15_18.csv"]])
df_EVI[['EVI_0m']] <- first(df[['EVI_0m']])
View(df_EVI)
View(df_EVI[["/Users/ifeomaozodiegwu/Box/NU-malaria-team/data/nigeria_dhs/data_analysis/data/DHS/Computed_cluster_information/urban_malaria_covariates/geospatial_covariates/EVI_0m_buffer_DHS_10_15_18.csv"]])
