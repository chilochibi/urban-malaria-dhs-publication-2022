p[[2]]
p[[1]]
p[[5]]
lapply(list(vars, lables, y_lim),
function(i)
p <- ggplot(eff_dt, aes(cat(vars[[i]]), fit))+
geom_ribbon(aes(ymin=lower, ymax=upper), alpha =0.2, fill = "springgreen1")+
geom_line(color = "maroon", size = 1)+ theme_manuscript()+ ylim(0, y_lim[[i]])+
labs)
lapply(list(vars, lables, y_lim),
function(i)
p <- ggplot(eff_dt, aes(cat(vars[[i]]), fit))+
geom_ribbon(aes(ymin=lower, ymax=upper), alpha =0.2, fill = "springgreen1")+
geom_line(color = "maroon", size = 1)+ theme_manuscript()+ ylim(0, y_lim[[i]])+
labs(x = '% with post-primary education (adjusted)', y ='malaria positives'))
lapply(list(vars, lables, y_lim),
function(i)
p <- ggplot(eff_dt, aes(cat(vars[[i]]), fit))+
geom_ribbon(aes(ymin=lower, ymax=upper), alpha =0.2, fill = "springgreen1")+
geom_line(color = "maroon", size = 1)+ theme_manuscript()+ ylim(0, y_lim[[i]])+
labs(x = '% with post-primary education (adjusted)', y ='malaria positives'))
lapply(list(vars, lables, y_lim),
function(i)
p <- ggplot(eff_dt, aes(cat(vars[[i]]), fit))+
geom_ribbon(aes(ymin=lower, ymax=upper), alpha =0.2, fill = "springgreen1")+
geom_line(color = "maroon", size = 1)+ theme_manuscript()+
labs(x = '% with post-primary education (adjusted)', y ='malaria positives'))
for (i in 1:7) {
eff <- Effect(vars[[i]], fit_zinbinom)
eff_dt <- data.frame(eff)
i <- i
p <- ggplot(eff_dt, aes(cat(vars[[i]]), fit))+
geom_ribbon(aes(ymin=lower, ymax=upper), alpha =0.2, fill = "springgreen1")+
geom_line(color = "maroon", size = 1)+ theme_manuscript()+ ylim(0, y_lim[[i]])+
labs(x = '% with post-primary education (adjusted)', y ='malaria positives')
p
}
p[[1]]
p[[2]]
label_list <- list(1:7)
label_list
for (i in 1:7) {
eff <- Effect(vars[label_list[[i]]], fit_zinbinom)
eff_dt <- data.frame(eff)
p = ggplot(eff_dt,aes(cat(vars[label_list[[i]]]), fit))+ +
geom_ribbon(aes(ymin=lower, ymax=upper), alpha =0.2, fill = "springgreen1")+
geom_line(color = "maroon", size = 1)+ theme_manuscript()+ ylim(0, y_lim[label_list[[i]]])+
labs(x = '% with post-primary education (adjusted)', y ='malaria positives')
pl[[i]]<- p
}
pl[[1]]
memory.limit(56000000000)
for (i in 1:7) {
eff <- Effect(vars[label_list[[i]]], fit_zinbinom)
eff_dt <- data.frame(eff)
pt = ggplot(eff_dt,aes(cat(vars[label_list[[i]]]), fit))+ +
geom_ribbon(aes(ymin=lower, ymax=upper), alpha =0.2, fill = "springgreen1")+
geom_line(color = "maroon", size = 1)+ theme_manuscript()+ ylim(0, y_lim[label_list[[i]]])+
labs(x = '% with post-primary education (adjusted)', y ='malaria positives')
p[[1]]<- pt
}
eff <- Effect(vars[label_list[[2]]], fit_zinbinom)
vars[label_list[[2]]]
vars[label_list[2]]
label_list <- list(1:7)
vars[label_list[2]]
label_list <- list(1,7)
label_list
label_list <- c(1:7)
label_list
vars[label_list[[2]]]
cat(vars[label_list[[2]]])
cat(vars[label_list[[2]]])
vars[label_list[[2]]]
vars[label_list[2]]
cat(vars[label_list[2]])
label_list[[2]]]
vars[label_list[[2]]]
y_lim[label_list[[2]]]
eff <- Effect(vars[label_list[[2]]], fit_zinbinom)
eff_dt <- data.frame(eff)
pt = ggplot(eff_dt,aes_string(vars[label_list[[2]]], fit))+ +
geom_ribbon(aes(ymin=lower, ymax=upper), alpha =0.2, fill = "springgreen1")+
geom_line(color = "maroon", size = 1)+ theme_manuscript()+ ylim(0, y_lim[label_list[[2]]])+
labs(x = '% with post-primary education (adjusted)', y ='malaria positives')
pt = ggplot(eff_dt,aes_string(vars[label_list[[2]]], 'fit'))+ +
geom_ribbon(aes(ymin=lower, ymax=upper), alpha =0.2, fill = "springgreen1")+
geom_line(color = "maroon", size = 1)+ theme_manuscript()+ ylim(0, y_lim[label_list[[2]]])+
labs(x = '% with post-primary education (adjusted)', y ='malaria positives')
p <- list()
for (i in 1:7) {
eff <- Effect(vars[label_list[[2]]], fit_zinbinom)
eff_dt <- data.frame(eff)
pt = ggplot(eff_dt,aes_string(vars[label_list[[2]]], 'fit'))+ +
geom_ribbon(aes(ymin=lower, ymax=upper), alpha =0.2, fill = "springgreen1")+
geom_line(color = "maroon", size = 1)+ theme_manuscript()+ ylim(0, y_lim[label_list[[2]]])+
labs(x = '% with post-primary education (adjusted)', y ='malaria positives')
p[[1]]<- pt
}
pt = ggplot(eff_dt,aes_string(vars[label_list[[2]]], 'fit'))+ +
geom_ribbon(aes(ymin=lower, ymax=upper), alpha =0.2, fill = "springgreen1")+
geom_line(color = "maroon", size = 1)+ theme_manuscript()+ ylim(0, y_lim[label_list[[2]]])+
labs(x = '% with post-primary education (adjusted)', y ='malaria positives')
pt = ggplot(eff_dt,aes_string(vars[label_list[[2]]], 'fit'))+
geom_ribbon(aes(ymin=lower, ymax=upper), alpha =0.2, fill = "springgreen1")+
geom_line(color = "maroon", size = 1)+ theme_manuscript()+ ylim(0, y_lim[label_list[[2]]])+
labs(x = '% with post-primary education (adjusted)', y ='malaria positives')
pt = ggplot(eff_dt,aes_string(vars[label_list[[2]]], 'fit'))+
geom_ribbon(aes(ymin=lower, ymax=upper), alpha =0.2, fill = "springgreen1")+
geom_line(color = "maroon", size = 1)+ theme_manuscript()+
labs(x = '% with post-primary education (adjusted)', y ='malaria positives')
pt
vars <- list('edu_a', 'wealth', 'pop_density_0m', 'median_age', 'med_treat_fever',
'precipitation_monthly_0m', 'EVI_0m')
lables <- list('% with post-primary education (adjusted)', '% in the rich wealth quintiles (adjusted)',
'All age population density', 'Median age (adjusted)', '% of U5 children that sought
medical treatment for fever (adjusted)', 'Total precipitation (adjusted)', 'Total precipitation (adjusted)',
'Enhanced Vegetation Index (adjusted)')
y_lim <- list(4.53, 4.6, 40, 6.1, 3.5, 3, 7.5)
label_list <- c(1:7)
xlab_data[label_list[[i]]]
p <- list()
for (i in 1:7) {
eff <- Effect(vars[label_list[[2]]], fit_zinbinom)
eff_dt <- data.frame(eff)
pt = ggplot(eff_dt,aes_string(vars[label_list[[2]]], 'fit'))+
geom_ribbon(aes(ymin=lower, ymax=upper), alpha =0.2, fill = "springgreen1")+
geom_line(color = "maroon", size = 1)+ theme_manuscript()+
labs(x = '% with post-primary education (adjusted)', y ='malaria positives')
p[[1]]<- pt
}
pt
vars[label_list[[2]]]
eff <- Effect(vars[[2]], fit_zinbinom)
eff_dt <- data.frame(eff)
pt = ggplot(eff_dt,aes_string(vars[[2]], 'fit'))+
geom_ribbon(aes(ymin=lower, ymax=upper), alpha =0.2, fill = "springgreen1")+
geom_line(color = "maroon", size = 1)+ theme_manuscript()+
labs(x = '% with post-primary education (adjusted)', y ='malaria positives')
pt
eff <- Effect(vars[[3]], fit_zinbinom)
eff_dt <- data.frame(eff)
pt = ggplot(eff_dt,aes_string(vars[[3]], 'fit'))+
geom_ribbon(aes(ymin=lower, ymax=upper), alpha =0.2, fill = "springgreen1")+
geom_line(color = "maroon", size = 1)+ theme_manuscript()+
labs(x = '% with post-primary education (adjusted)', y ='malaria positives')
p[[1]]<- pt
pt
p <- list()
for (i in 1:7) {
eff <- Effect(vars[[i]], fit_zinbinom)
eff_dt <- data.frame(eff)
pt = ggplot(eff_dt,aes_string(vars[[i]], 'fit'))+
geom_ribbon(aes(ymin=lower, ymax=upper), alpha =0.2, fill = "springgreen1")+
geom_line(color = "maroon", size = 1)+ theme_manuscript()+
labs(x = '% with post-primary education (adjusted)', y ='malaria positives')
p[[1]]<- pt
}
p[[1]]
for (i in 1:7) {
eff <- Effect(vars[[i]], fit_zinbinom)
eff_dt <- data.frame(eff)
pt = ggplot(eff_dt,aes_string(vars[[i]], 'fit'))+
geom_ribbon(aes(ymin=lower, ymax=upper), alpha =0.2, fill = "springgreen1")+
geom_line(color = "maroon", size = 1)+ theme_manuscript()+
labs(x = '% with post-primary education (adjusted)', y ='malaria positives')
p[[i]]<- pt
}
p[[1]]
p[[2]]
y=p[[1]]+ p[[2]] + p[[3]] + p[[4]] + p[[5]] + p[[6]] + p[[7]]
y
for (i in 1:7) {
eff <- Effect(vars[[i]], fit_zinbinom)
eff_dt <- data.frame(eff)
pt = ggplot(eff_dt,aes_string(vars[[i]], 'fit'))+
geom_ribbon(aes(ymin=lower, ymax=upper), alpha =0.2, fill = "springgreen1")+
geom_line(color = "maroon", size = 1)+ theme_manuscript()+
labs(x = lables[[i]], y ='malaria positives')
p[[i]]<- pt
}
y=p[[1]]+ p[[2]] + p[[3]] + p[[4]] + p[[5]] + p[[6]] + p[[7]]
y
#Selecting final model based on AIC comparison
dplyr::bind_rows(aics_all, aics_all_models, aics_env, aics_acc, aics_behav, aics_demo, aics_ses)
bm1 <- glmmTMB(positives~ns(edu_a, 3), data =map, family=nbinom2)
bm2 <- glmmTMB(positives~ns(wealth, 3), data =map, ziformula=~1, family=nbinom2)
bm3 <- glmmTMB(positives~ns(pop_density_0m,2), data =map, ziformula=~1, family=nbinom2)
bm4 <- glmmTMB(positives~ns(median_age, 2), data =map, ziformula=~1, family=nbinom2)
bm5 <- glmmTMB(positives~ns(precipitation_monthly_0m, 3), data =map, ziformula=~1, family=nbinom2)
val = map %>%  drop_na(med_treat_fever)
bm6 <- glmmTMB(positives~ ns(med_treat_fever, knots = seq(min(med_treat_fever),max(med_treat_fever),length =4)[2:3]), data =val, ziformula=~1, family=nbinom2)
bm7 <- glmmTMB(positives~ns(EVI_0m,3), data =map, ziformula=~1, family=nbinom2)
#Bivariate effect plots
bi_models <- list(bm1, bm2, bm3, bm4, bm5, bm6, bm7)
b <- list()
for (i in 1:7) {
eff <- Effect(vars[[i]], bi_models[[i]])
eff_dt <- data.frame(eff)
pt = ggplot(eff_dt,aes_string(vars[[i]], 'fit'))+
geom_ribbon(aes(ymin=lower, ymax=upper), alpha =0.2, fill = "springgreen1")+
geom_line(color = "maroon", size = 1)+ theme_manuscript()+
labs(x = lables[[i]], y ='malaria positives')
b[[i]]<- pt
}
bm6 <- glmmTMB(positives~ ns(med_treat_fever, knots = seq(min(med_treat_fever),max(med_treat_fever),length =4)[2:3]), data =val, ziformula=~1, family=nbinom2)
bm1 <- glmmTMB(positives~ns(edu_a, 3), data =map, family=nbinom2)
bm2 <- glmmTMB(positives~ns(wealth, 3), data =map, ziformula=~1, family=nbinom2)
bm3 <- glmmTMB(positives~ns(pop_density_0m,2), data =map, ziformula=~1, family=nbinom2)
bm4 <- glmmTMB(positives~ns(median_age, 2), data =map, ziformula=~1, family=nbinom2)
val = map %>%  drop_na(med_treat_fever)
bm5 <- glmmTMB(positives~ ns(med_treat_fever, knots = seq(min(med_treat_fever),max(med_treat_fever),length =4)[2:3]), data =val, ziformula=~1, family=nbinom2)
bm6 <- glmmTMB(positives~ns(precipitation_monthly_0m, 3), data =map, ziformula=~1, family=nbinom2)
bm7 <- glmmTMB(positives~ns(EVI_0m,3), data =map, ziformula=~1, family=nbinom2)
#Bivariate effect plots
bi_models <- list(bm1, bm2, bm3, bm4, bm5, bm6, bm7)
b <- list()
for (i in 1:7) {
eff <- Effect(vars[[i]], bi_models[[i]])
eff_dt <- data.frame(eff)
pt = ggplot(eff_dt,aes_string(vars[[i]], 'fit'))+
geom_ribbon(aes(ymin=lower, ymax=upper), alpha =0.2, fill = "springgreen1")+
geom_line(color = "maroon", size = 1)+ theme_manuscript()+
labs(x = lables[[i]], y ='malaria positives')
b[[i]]<- pt
}
b_plots=b[[1]]+ b[[2]] + b[[3]] + b[[4]] + b[[5]] + b[[6]] + b[[7]]
b_plots
p = (p[[1]] + b[[1]]) / (p[[2]] + b[[2]]) + plot_annotation(tag_levels = 'A')&
theme(plot.tag = element_text(size = 12, face = 'bold'), legend.position = 'bottom')
p
for (i in 1:7) {
eff <- Effect(vars[[i]], bi_models[[i]])
eff_dt <- data.frame(eff)
pt = ggplot(eff_dt,aes_string(vars[[i]], 'fit'))+
geom_ribbon(aes(ymin=lower, ymax=upper), alpha =0.2, fill = "springgreen1")+
geom_line(color = "maroon", size = 1)+ theme_manuscript()+
labs(x = lables[[i]], paste('adjusteddd'), y ='malaria positives')
b[[i]]<- pt
}
b_plots=b[[1]]+ b[[2]] + b[[3]] + b[[4]] + b[[5]] + b[[6]] + b[[7]]
b_plots
for (i in 1:7) {
eff <- Effect(vars[[i]], bi_models[[i]])
eff_dt <- data.frame(eff)
pt = ggplot(eff_dt,aes_string(vars[[i]], 'fit'))+
geom_ribbon(aes(ymin=lower, ymax=upper), alpha =0.2, fill = "springgreen1")+
geom_line(color = "maroon", size = 1)+ theme_manuscript()+
labs(x = lables[[i]] + 'adjusteddd', y ='malaria positives')
b[[i]]<- pt
}
for (i in 1:7) {
eff <- Effect(vars[[i]], bi_models[[i]])
eff_dt <- data.frame(eff)
pt = ggplot(eff_dt,aes_string(vars[[i]], 'fit'))+
geom_ribbon(aes(ymin=lower, ymax=upper), alpha =0.2, fill = "springgreen1")+
geom_line(color = "maroon", size = 1)+ theme_manuscript()+
labs(x = lables[[i]] & 'gvs', y ='malaria positives')
b[[i]]<- pt
}
for (i in 1:7) {
eff <- Effect(vars[[i]], bi_models[[i]])
eff_dt <- data.frame(eff)
pt = ggplot(eff_dt,aes_string(vars[[i]], 'fit'))+
geom_ribbon(aes(ymin=lower, ymax=upper), alpha =0.2, fill = "springgreen1")+
geom_line(color = "maroon", size = 1)+ theme_manuscript()+
labs(x = lables[[i]] & 'gvs', y ='malaria positives')
b[[i]]<- pt
}
for (i in 1:7) {
eff <- Effect(vars[[i]], bi_models[[i]])
eff_dt <- data.frame(eff)
pt = ggplot(eff_dt,aes_string(vars[[i]], 'fit'))+
geom_ribbon(aes(ymin=lower, ymax=upper), alpha =0.2, fill = "springgreen1")+
geom_line(color = "maroon", size = 1)+ theme_manuscript()+
labs(x = lables[[i]], y ='malaria positives')
b[[i]]<- pt
}
for (i in 1:7) {
eff <- Effect(vars[[i]], bi_models[[i]])
eff_dt <- data.frame(eff)
pt = ggplot(eff_dt,aes_string(vars[[i]], 'fit'))+
geom_ribbon(aes(ymin=lower, ymax=upper), alpha =0.2, fill = "springgreen1")+
geom_line(color = "maroon", size = 1)+ theme_manuscript()+
labs(x = lables[[i]],paste0('dd'), y ='malaria positives')
b[[i]]<- pt
}
b_plots
'ytt' +trr
"trr" + 'rtr'
string(fsdfs)
for (i in 1:7) {
eff <- Effect(vars[[i]], bi_models[[i]])
eff_dt <- data.frame(eff)
pt = ggplot(eff_dt,aes_string(vars[[i]], 'fit'))+
geom_ribbon(aes(ymin=lower, ymax=upper), alpha =0.2, fill = "springgreen1")+
geom_line(color = "maroon", size = 1)+ theme_manuscript()+
labs(x = lables[[i]],paste0(as.character('dddd')), y ='malaria positives')
b[[i]]<- pt
}
b_plots=b[[1]]+ b[[2]] + b[[3]] + b[[4]] + b[[5]] + b[[6]] + b[[7]]
b_plots
for (i in 1:7) {
eff <- Effect(vars[[i]], bi_models[[i]])
eff_dt <- data.frame(eff)
pt = ggplot(eff_dt,aes_string(vars[[i]], 'fit'))+
geom_ribbon(aes(ymin=lower, ymax=upper), alpha =0.2, fill = "springgreen1")+
geom_line(color = "maroon", size = 1)+ theme_manuscript()+
labs(x = paste0(as.character('dddd'), as.character(lables[[i]])), y ='malaria positives')
b[[i]]<- pt
}
b_plots=b[[1]]+ b[[2]] + b[[3]] + b[[4]] + b[[5]] + b[[6]] + b[[7]]
b_plots
b <- list()
for (i in 1:7) {
eff <- Effect(vars[[i]], bi_models[[i]])
eff_dt <- data.frame(eff)
pt = ggplot(eff_dt,aes_string(vars[[i]], 'fit'))+
geom_ribbon(aes(ymin=lower, ymax=upper), alpha =0.2, fill = "springgreen1")+
geom_line(color = "maroon", size = 1)+ theme_manuscript()+
labs(x = paste0(as.character('dddd')," ",as.character(lables[[i]])), y ='malaria positives')
b[[i]]<- pt
}
b_plots=b[[1]]+ b[[2]] + b[[3]] + b[[4]] + b[[5]] + b[[6]] + b[[7]]
b_plots
#Bivariate effect plots
lables <- list('% with post-primary education', '% in the rich wealth quintiles',
'All age population density', 'Median age', '% of U5 children that sought
medical treatment for fever', 'Total precipitation', 'Total precipitation',
'Enhanced Vegetation Index')
bi_models <- list(bm1, bm2, bm3, bm4, bm5, bm6, bm7)
b <- list()
for (i in 1:7) {
eff <- Effect(vars[[i]], bi_models[[i]])
eff_dt <- data.frame(eff)
pt = ggplot(eff_dt,aes_string(vars[[i]], 'fit'))+
geom_ribbon(aes(ymin=lower, ymax=upper), alpha =0.2, fill = "springgreen1")+
geom_line(color = "maroon", size = 1)+ theme_manuscript()+
labs(x = paste0(as.character(lables[[i]]), ' ', as.character('(unadjusted)')), y ='malaria positives')
b[[i]]<- pt
}
b_plots=b[[1]]+ b[[2]] + b[[3]] + b[[4]] + b[[5]] + b[[6]] + b[[7]]
b_plots
for (i in 1:7) {
eff <- Effect(vars[[i]], fit_zinbinom)
eff_dt <- data.frame(eff)
pt = ggplot(eff_dt,aes_string(vars[[i]], 'fit'))+
geom_ribbon(aes(ymin=lower, ymax=upper), alpha =0.2, fill = "springgreen1")+
geom_line(color = "maroon", size = 1)+ theme_manuscript()+
labs(x = paste0(as.character(lables[[i]]), ' ', as.character('(adjusted)')), y ='malaria positives')
p[[i]]<- pt
}
y=p[[1]]+ p[[2]] + p[[3]] + p[[4]] + p[[5]] + p[[6]] + p[[7]]
y
plot_arang = ggarrange(b[[1]], NULL, p[[1]], b[[2]], NULL, p[[2]],
b[[3]], NULL, p[[3]], b[[4]], NULL, p[[4]],
b[[5]], NULL, p[[5]], b[[6]], NULL, b[[6]],
b[[7]], NULL, b[[7]],
nrow = 7, ncol= 3, widths = c(1,0.05,1))
plot_arang = ggarrange(b[[1]], NULL, p[[1]], b[[2]], NULL, p[[2]],
b[[3]], NULL, p[[3]], b[[4]], NULL, p[[4]],
b[[5]], NULL, p[[5]], b[[6]], NULL, b[[6]],
b[[7]], NULL, b[[7]],
nrow = 7, ncol= 3, widths = c(1,0.05,1))
library(ggpubr)
plot_arang = ggarrange(b[[1]], NULL, p[[1]], b[[2]], NULL, p[[2]],
b[[3]], NULL, p[[3]], b[[4]], NULL, p[[4]],
b[[5]], NULL, p[[5]], b[[6]], NULL, b[[6]],
b[[7]], NULL, b[[7]],
nrow = 7, ncol= 3, widths = c(1,0.05,1))
plot_arang
plot_arang = ggarrange(b[[1]], NULL, p[[1]], b[[2]], NULL, p[[2]],
b[[3]], NULL, p[[3]], b[[4]], NULL, p[[4]],
b[[5]], NULL, p[[5]], b[[6]], NULL, p[[6]],
b[[7]], NULL, p[[7]],
nrow = 7, ncol= 3, widths = c(1,0.05,1))
plot_arang
models<- list(bm1 <- glmmTMB(positives~ns(edu_a, 3), data =map, family=nbinom2),
bm2 <- glmmTMB(positives~ns(wealth, 3), data =map, ziformula=~1, family=nbinom2),
bm3 <- glmmTMB(positives~ns(pop_density_0m,2), data =map, ziformula=~1, family=nbinom2),
bm4 <- glmmTMB(positives~ns(median_age, 2), data =map, ziformula=~1, family=nbinom2),
bm5 <- glmmTMB(positives~ ns(med_treat_fever, knots = seq(min(med_treat_fever),max(med_treat_fever),length =4)[2:3]), data =val, ziformula=~1, family=nbinom2),
bm6 <- glmmTMB(positives~ns(precipitation_monthly_0m, 3), data =map, ziformula=~1, family=nbinom2),
bm7 <- glmmTMB(positives~ns(EVI_0m,3), data =map, ziformula=~1, family=nbinom2))
rm(list=ls())
memory.limit(size = 50000)
Drive <- file.path(gsub("[\\]", "/", gsub("Documents", "", Sys.getenv("HOME"))))
NuDir <- file.path(Drive, "Box", "NU-malaria-team")
NGDir <-file.path(NuDir, "data", "nigeria","nigeria_dhs",  "data_analysis")
DataDir <-file.path(NGDir, "data")
ResultDir <-file.path(NGDir, "results")
DHSData <- file.path(DataDir, 'DHS')
DataIn <- file.path(DHSData, "Computed_cluster_information", 'urban_malaria_covariates',
'cleaned_cluster_covariates_all', 'New_082321')
MultivarData <- file.path(DataIn, 'final_dataset_multivariate_analysis')
# ------------------------------------------
### Required functions and settings
## -----------------------------------------
source("./other_functions/multivariate_functions.R")
# ------------------------------------------
### Read in analysis data
## -----------------------------------------
dat = read.csv(file.path(MultivarData, 'multivariate_analysis_dataset.csv'))
#load spatial points to do Moran's I test
sf18 = st_read(file.path(DHSData, "Downloads", "NG_2018_DHS_11072019_1720_86355/NGGE7BFL/NGGE7BFL.shp"),)
sf15 = st_read(file.path(DHSData, "Downloads", "NG_2015_MIS_06192019/NGGE71FL/NGGE71FL.shp"),)
sf10 = st_read(file.path(DHSData, "Downloads", "NG_2010_MIS_06192019/NGGE61FL/NGGE61FL.shp"),)
sf_all = rbind(sf18, sf15, sf10) %>%filter(URBAN_RURA == "U") %>%  rename(v001 = DHSCLUST, dhs_year=DHSYEAR) %>%
dplyr::mutate(lat = sf::st_coordinates(.)[,1],
lon = sf::st_coordinates(.)[,2])
# ------------------------------------------
### Read in analysis data
## -----------------------------------------
dat = read.csv(file.path(MultivarData, 'multivariate_analysis_dataset.csv'))
#load spatial points to do Moran's I test
sf18 = st_read(file.path(DHSData, "Downloads", "NG_2018_DHS_11072019_1720_86355/NGGE7BFL/NGGE7BFL.shp"),)
sf15 = st_read(file.path(DHSData, "Downloads", "NG_2015_MIS_06192019/NGGE71FL/NGGE71FL.shp"),)
sf10 = st_read(file.path(DHSData, "Downloads", "NG_2010_MIS_06192019/NGGE61FL/NGGE61FL.shp"),)
sf_all = rbind(sf18, sf15, sf10) %>%filter(URBAN_RURA == "U") %>%  rename(v001 = DHSCLUST, dhs_year=DHSYEAR) %>%
dplyr::mutate(lat = sf::st_coordinates(.)[,1],
lon = sf::st_coordinates(.)[,2])
# ------------------------------------------
### Read in analysis data
## -----------------------------------------
dat = read.csv(file.path(MultivarData, 'multivariate_analysis_dataset.csv'))
#load spatial points to do Moran's I test
sf18 = st_read(file.path(DHSData, "Downloads", "NG_2018_DHS_11072019_1720_86355/NGGE7BFL/NGGE7BFL.shp"),)
sf15 = st_read(file.path(DHSData, "Downloads", "NG_2015_MIS_06192019/NGGE71FL/NGGE71FL.shp"),)
sf10 = st_read(file.path(DHSData, "Downloads", "NG_2010_MIS_06192019/NGGE61FL/NGGE61FL.shp"),)
sf_all = rbind(sf18, sf15, sf10) %>%filter(URBAN_RURA == "U") %>%  rename(v001 = DHSCLUST, dhs_year=DHSYEAR) %>%
dplyr::mutate(lat = sf::st_coordinates(.)[,1],
lon = sf::st_coordinates(.)[,2])
sf_all = rbind(sf18, sf15, sf10)
sf_all = rbind(sf18, sf15, sf10) %>%filter(URBAN_RURA == "U")
sf_all = rbind(sf18, sf15, sf10) %>%filter(URBAN_RURA == "U") %>%  rename(v001 = DHSCLUST, dhs_year=DHSYEAR)
sf_all = rbind(sf18, sf15, sf10) %>%filter(URBAN_RURA == "U")
sf_all = rbind(sf18, sf15, sf10) %>%filter(URBAN_RURA == "U") %>%  dplyr::rename(v001 = DHSCLUST, dhs_year=DHSYEAR) %>%
dplyr::mutate(lat = sf::st_coordinates(.)[,1],
lon = sf::st_coordinates(.)[,2])
map = sf_all %>% left_join(dat, by=c('v001', 'dhs_year')) %>%  filter(LATNUM != 0)
response.dists <- as.matrix(dist(cbind(map$lon, map$lat)))
response.dists.inv <- 1/response.dists
diag(response.dists.inv) <- 0
#
response.dists.inv[1:5, 1:5]
#
Moran.I(map$positives, response.dists.inv, na.rm = TRUE)# p=7.34987e-07, spatial autocorrelation exists
bi_models <- list(bm1 <- glmmTMB(positives~ns(edu_a, 3), data =map, family=nbinom2),
bm2 <- glmmTMB(positives~ns(wealth, 3), data =map, ziformula=~1, family=nbinom2),
bm3 <- glmmTMB(positives~ns(pop_density_0m,2), data =map, ziformula=~1, family=nbinom2),
bm4 <- glmmTMB(positives~ns(median_age, 2), data =map, ziformula=~1, family=nbinom2),
bm5 <- glmmTMB(positives~ ns(med_treat_fever, knots = seq(min(med_treat_fever),max(med_treat_fever),length =4)[2:3]), data =val, ziformula=~1, family=nbinom2),
bm6 <- glmmTMB(positives~ns(precipitation_monthly_0m, 3), data =map, ziformula=~1, family=nbinom2),
bm7 <- glmmTMB(positives~ns(EVI_0m,3), data =map, ziformula=~1, family=nbinom2))
#bivariate analysis
val = map %>%  drop_na(med_treat_fever)
bi_models <- list(bm1 <- glmmTMB(positives~ns(edu_a, 3), data =map, family=nbinom2),
bm2 <- glmmTMB(positives~ns(wealth, 3), data =map, ziformula=~1, family=nbinom2),
bm3 <- glmmTMB(positives~ns(pop_density_0m,2), data =map, ziformula=~1, family=nbinom2),
bm4 <- glmmTMB(positives~ns(median_age, 2), data =map, ziformula=~1, family=nbinom2),
bm5 <- glmmTMB(positives~ ns(med_treat_fever, knots = seq(min(med_treat_fever),max(med_treat_fever),length =4)[2:3]), data =val, ziformula=~1, family=nbinom2),
bm6 <- glmmTMB(positives~ns(precipitation_monthly_0m, 3), data =map, ziformula=~1, family=nbinom2),
bm7 <- glmmTMB(positives~ns(EVI_0m,3), data =map, ziformula=~1, family=nbinom2))
b <- list()
for (i in 1:7) {
eff <- Effect(vars[[i]], bi_models[[i]])
eff_dt <- data.frame(eff)
pt = ggplot(eff_dt,aes_string(vars[[i]], 'fit'))+
geom_ribbon(aes(ymin=lower, ymax=upper), alpha =0.2, fill = "springgreen1")+
geom_line(color = "maroon", size = 1)+ theme_manuscript()+
labs(x = paste0(as.character(lables[[i]]), ' ', as.character('(unadjusted)')), y ='malaria positives')
b[[i]]<- pt
}
bi_models[[1]]
bi_models[[7]]
vars <- list('edu_a', 'wealth', 'pop_density_0m', 'median_age', 'med_treat_fever',
'precipitation_monthly_0m', 'EVI_0m')
lables <- list('% with post-primary education', '% in the rich wealth quintiles',
'All age population density', 'Median age', '% of U5 children that sought
medical treatment for fever', 'Total precipitation', 'Total precipitation',
'Enhanced Vegetation Index')
y_lim <- list(4.53, 4.6, 40, 6.1, 3.5, 3, 7.5)
b <- list()
for (i in 1:7) {
eff <- Effect(vars[[i]], bi_models[[i]])
eff_dt <- data.frame(eff)
pt = ggplot(eff_dt,aes_string(vars[[i]], 'fit'))+
geom_ribbon(aes(ymin=lower, ymax=upper), alpha =0.2, fill = "springgreen1")+
geom_line(color = "maroon", size = 1)+ theme_manuscript()+
labs(x = paste0(as.character(lables[[i]]), ' ', as.character('(unadjusted)')), y ='malaria positives')
b[[i]]<- pt
}
b_plots=b[[1]]+ b[[2]] + b[[3]] + b[[4]] + b[[5]] + b[[6]] + b[[7]]
b_plots
#Bivariate effect plots
for (i in 1:7) {
b <- list()
eff <- Effect(vars[[i]], bi_models[[i]])
eff_dt <- data.frame(eff)
pt = ggplot(eff_dt,aes_string(vars[[i]], 'fit'))+
geom_ribbon(aes(ymin=lower, ymax=upper), alpha =0.2, fill = "springgreen1")+
geom_line(color = "maroon", size = 1)+ theme_manuscript()+
labs(x = paste0(as.character(lables[[i]]), ' ', as.character('(unadjusted)')), y ='malaria positives')
b[[i]]<- pt
}
b_plots=b[[1]]+ b[[2]] + b[[3]] + b[[4]] + b[[5]] + b[[6]] + b[[7]]
b_plots
summary(bi_models)
sapply(summary, bi_models)
sapply(bi_models, summary)
lapply(bi_models, summary)
lapply(all_mods2, summary)
